<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Headless Visual Testing For Web Applications</title>
    <meta name="description" content="A story of utilizing existing resources and setup a visual testing pipeline for applications.">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/prism.base16.monokai.dark.css">
    
      <link rel="stylesheet" href="/css/home.css">
    
      <link rel="stylesheet" href="/css/footer.css">
    
      <link rel="stylesheet" href="/css/post.css">
    
    <link rel="alternate" href="." type="application/atom+xml" title="">
    <link rel="alternate" href="." type="application/json" title="">
    <script src="https://kit.fontawesome.com/0a5d5a6a83.js" crossorigin="anonymous"></script>
  </head>
  <body>
  <section class="container-fluid align-items-center">
       <div class="row dark-bg">
         <nav class="navbar navbar-expand-lg">
    <span class="navbar-brand">
        <img class="hero" src="/images/about_me.jpg" />
    </span>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavDropdown">
      <ul class="navbar-nav">
      
        <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="/tech/">Tech</a></li>
        <li class="nav-item"><a class="nav-link" href="/leadership/">Leadership</a></li>
        <li class="nav-item"><a class="nav-link" href="/playbooks/">Play Books</a></li>
      </ul>
    </div>
  </nav>
      </div>
      <div class="row main-row">
      <div class="col-lg-12">
       
<section class="container-fluid align-items-center post" >
  <img src="https://source.unsplash.com/U3sOwViXhkY/1600x900" class="banner"/>
  <div class="credit">
    <a target="_blank" href="https://unsplash.com/@franckinjapan">Franck V.</a> on 
    <a target="_blank" href="https://unsplash.com">Unsplash </a>
  </div>
  <h1>Headless Visual Testing For Web Applications
  </h1>

  <div class="meta">
  <p class="date">Jul 30, 2018</p>
    
        <a href="/tags/tech/" class="post-tag">#tech</a>
        <a href="/tags/automation/" class="post-tag">#automation</a>
        <a href="/tags/testing/" class="post-tag">#testing</a>
    
  </div>
  <p>
    <p><strong>Some time back</strong>, A team had come across an interesting challenge. The team, let’s call them <em>Rangers</em>, had embarked on a journey creating a cross platform enterprise application which would allow them to write business logic once and deploy it as an iOS app, an Android app as well as a Web application.</p>
<p>Rangers were doing great. They had precise test suites honoring the <a href="https://martinfowler.com/bliki/TestPyramid.html">test pyramid</a>. A well thought of CI system to execute them and a clear path to production. They also implemented UI Testing framework to run on top of their current infrastructure and capture UI issues as part of the feedback. It worked flawlessly on the mobile apps.</p>
<p><em>But not the web app</em>. The tests were flaky and would fail for no apparent reasons in some runs while they would pass on others. Rangers spent hours debugging the root cause: the Chrome browser version, the chrome-driver, ImageMagick comparisons and the fuzz factor. They even tried to have exact identical agents, hardware and software images but still couldn’t pin point the root cause.</p>
<p>On verge of giving up, one Ranger asked a very important question: <strong>Is it the physical displays on the agents?</strong></p>
<p>Is it physical displays?</p>
<p>Images are made up of pixels. The physical displays (desktop monitors, laptop screens) arrange and render pixels onto the illuminated screen. The number of pixels in an image is always constant. However, it’s representation varies across displays depending on the capability of a display to pack pixels on the screen. this capability is measured as <strong>Pixel Per Inch (PPI)</strong> and can be deduced using formula below where height and width is the resolution set for the display (1080p, 720p, etc..) and <em>diagonal</em> is the diagonal length of display:</p>
<p><code>sqrt( height² + width²)/diagonal</code></p>
<p><img src="/images/headless-visual-testing-for-web-applications/res.png" alt="PPI screens"></p>
<p>This means that <em>for same resolution, displays of different sizes will render same image with a fuzz or slight variance</em>.</p>
<p>The Rangers realised that the key to get repeatable robust results is to control this PPI. However, the PPIs are property of physical display and cannot be altered or mocked. What required was a <em>virtual</em> display which can be configured, looked at and taken screenshot off. and <strong>Xvfb</strong> does just that. It’s a virtual <a href="https://en.wikipedia.org/wiki/Framebuffer">frame buffer</a> for X server, a full-fledged implementation which mocks the physical display with detailed configuration and even allows one to VNC!</p>
<h4 id="the-plan">The Plan <a class="direct-link" href="#the-plan">#</a></h4>
<p>Rangers decided that the best <em>robust, repeatable and portable</em> solution would be a <a href="https://en.wikipedia.org/wiki/Linux_containers">containerized</a> setup with test suites mounted and run against.</p>
<p>The plan was to have a <a href="https://www.docker.com/">Docker</a> image with <strong>Xvfb</strong>, <strong>Chromium</strong> and <strong>Chrome-driver</strong> setup to start at launch, along with <strong>x11vnc</strong> to provide a VNC just in case it was required to debug. The required modules for test automation viz. <a href="https://www.seleniumhq.org/">Selenium</a>, <a href="https://www.imagemagick.org/">ImageMagick</a> was also baked in to the image.</p>
<p>Consider below sample Dockerfile which creates a light weight docker image and starts the Xvfb and VNC:</p>
<pre class="language-docker"><code class="language-docker"><span class="token keyword">FROM</span> alpine<br><span class="token keyword">RUN</span> echo <span class="token string">"http://dl-4.alpinelinux.org/alpine/latest-stable/main"</span> <span class="token punctuation">></span><span class="token punctuation">></span> /etc/apk/repositories &amp;&amp; \<br>echo <span class="token string">"http://dl-4.alpinelinux.org/alpine/latest-stable/community"</span> <span class="token punctuation">></span><span class="token punctuation">></span> /etc/apk/repositories<br><span class="token keyword">RUN</span> apk update &amp;&amp; \ apk add xvfb x11vnc chromium chromium<span class="token punctuation">-</span>chromedriver imagemagickARG UID=1000<br><span class="token keyword">ENV</span> DISPLAY <span class="token punctuation">:</span>99<br><span class="token keyword">EXPOSE</span> 5900 VOLUME<br><span class="token keyword">VOLUME</span> /images<br><span class="token keyword">WORKDIR</span> /appRUN echo <span class="token string">'echo "starting Xvfb and x11vnc"'</span> <span class="token punctuation">></span><span class="token punctuation">></span> /app/init.sh &amp;&amp; \ <br>    echo <span class="token string">"`which Xvfb` $DISPLAY -dpi 100 -screen 0 1024x768x24 &amp;"</span> <span class="token punctuation">></span><span class="token punctuation">></span> /app/init.sh &amp;&amp; \<br>    echo <span class="token string">"`which x11vnc` -display $DISPLAY -forever >&amp;2 &amp;"</span> <span class="token punctuation">></span><span class="token punctuation">></span> /app/init.sh &amp;&amp; \<br>    echo <span class="token string">'echo "done."'</span> <span class="token punctuation">></span><span class="token punctuation">></span> /app/init.shRUN adduser <span class="token punctuation">-</span>D <span class="token punctuation">-</span>u $UID testrunner<br><span class="token keyword">USER</span> testrunner<br><span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"sh init.sh &amp;&amp; /bin/sh"</span><span class="token punctuation">]</span></code></pre>
<p>The above docker image, once built, can then be executed as</p>
<pre class="language-shell"><code class="language-shell">$ docker run -ti -p <span class="token number">5900</span>:5900 -v ~/test_dir/images:/images <span class="token operator">&lt;</span>image_name<span class="token operator">></span></code></pre>
<p>The command will start up the docker image, mounts the directories of interest, starts Xvfb and x11vnc that can be vnc’ed @ 127.0.0.1:5900.</p>
<p><img src="/images/headless-visual-testing-for-web-applications/flow-chart.png" alt="flow charts"></p>
<h4 id="the-result">The Result <a class="direct-link" href="#the-result">#</a></h4>
<p>The flakiness was gone and it opened up new possibilities of testing in isolation various different device configurations like iPhone, Samsung S8, tablets for responsive web tests using Chromium flags. <em>But that’s a story to be told some other day</em>.</p>
<blockquote>
<p>This blog is a transcript of a talk I gave at VodQA Pune. The slides are also available <a href="https://www.slideshare.net/manishkkatoch/visual-testing-of-web-apps-in-a-headless-environment">here</a>.</p>
<p>PS: There are tools and frameworks in markets which can be used instead, but cost considerable amount of money. The idea here is to utilize best of open source and existing investments to get fast feedbacks.</p>
</blockquote>

  </p>
  <hr><div class="publications">
    <p>This story was also published in:</p>
      <ul>
        
        <li class="p-0"><a target="_blank" href="https://codeburst.io/headless-visual-testing-for-web-applications-9b90d125ee5b" >codeburst.io</a></li>
        
      </ul>
  </div><ul class="post-nav">
      <li class="next">
        <a href="/tech/typesafety-and-spark-dataset-scala/">Type safety and Spark Datasets in Scala</a>
        <i class="fas fa-chevron-right tinted"></i>
      </li>
    
      <li class="previous">
        <i class="fas fa-chevron-left tinted"></i>
        <a href="/tech/swift-mvvm-two-way-binding-win/">Swift + MVVM + Two Way Binding = Win!</a>
      </li>
    
  </ul>
</section>
       </div>
      </div>
  </section>
    <section class="container-fluid p-0">
      
    </section>
    
    <section class="container-fluid dark-bg align-items-center mk-footer">
        <div class="row d-flex align-items-center p-0 mx-auto">
            <div class="col-lg-3 padded-col">
                <img class="hero d-block mx-auto" src="/images/about_me.jpg" />
            </div>
            <div class="col-lg-6 padded-col">
                <section class="bio">
                    I'm <b>Manish Katoch</b>.<br/><br/>
          I am a polyglot software developer who loves and strives to write simple, clean and testable code.<br/><br/>
          As a developer, I am partial towards Scala,
          Kotlin and everything functional. I also enjoy developing mobile applications and frameworks.<br/>
          As tech lead, I have collaborated with some of the key players in the Travel, BFSI and Consumer Electronics domain to build teams that create mission-critical, consumer enriching products/platforms.
          <br/><br/>
          previously worked with NVIDIA and ThoughtWorks, I currently work with a startup with a mission to make Industry 4.0 better.
        
                </section>
            </div>
            <div class="col-lg-1 padded-col"></div>
            <div class="col-lg-2 padded-col">
                
    
        <span>I'm reachable!</span><br/><br/>
        <ul class="list-unstyled p-10">
            
    
      
        <li><a target="_blank" href="mailTo:manish.katoch@gmail.com">
      
        <span><i class="fas fa-envelope-square"></i> Email</span>
    
      </a></li>
    
    
      
        <li><a target="_blank" href="https://www.linkedin.com/in/manishkkatoch/">
      
        <span><i class="fab fa-linkedin"></i> LinkedIn</span>
    
      </a></li>
    
    
      
        <li><a target="_blank" href="https://twitter.com/m_the_katoch">
      
        <span><i class="fab fa-twitter-square"></i> Twitter</span>
    
      </a></li>
    
    
      
        <li><a target="_blank" href="https://medium.com/@manish.katoch">
      
        <span><i class="fab fa-medium"></i> Medium</span>
    
      </a></li>
    
    
    
        </ul>
        <br/>
        <span>currently in:<span><br/>
        <span>Berlin, Germany</span>
    
    
            </div>
        </div>
        <div class="row d-flex align-items-center p-40 mx-auto copy">
            <p>&copy; Manish Katoch 2020</p>
        </div>
    </section>
  

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
  </body>
</html>